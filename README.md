CREATE DATABASE InventoryDB;

USE InventoryDB;

DROP TABLE SUPPLIERS;

CREATE TABLE SUPPLIERS (
    SUPPLIERSID INT IDENTITY(1,1) NOT NULL,
	SUPPLIERSNAME VARCHAR(30) NOT NULL,
	CONTACTNAME VARCHAR(30) NOT NULL,
	EMAIL VARCHAR(30) NOT NULL,
	PHONE VARCHAR(30) NOT NULL,
	ADDRESS VARCHAR(30) NOT NULL
	PRIMARY KEY(SUPPLIERSID)
);

DROP TABLE PRODUCTS;

CREATE TABLE PRODUCTS (
   PRODUCTID INT IDENTITY(2,2) NOT NULL,
   PRODUCTNAME VARCHAR(20) NOT NULL,
   CATEGORY VARCHAR(30) NOT NULL,
   PRICE DECIMAL(20,2) NOT NULL,
   STOCK INT NOT NULL,
   EXPIRYDATE DATE,
   SUPPLIERSID INT NOT NULL
   PRIMARY KEY(PRODUCTID)
);

DROP TABLE TRANSACTIONS;

CREATE TABLE TRANSACTIONS (
    TRANSACTIONID INT IDENTITY(3,3) NOT NULL,
	TRANSACTIONDATE DATE NOT NULL,
	QUANTITY INT NOT NULL,
	TRANSACTIONTYPE VARCHAR(30) NOT NULL,
	PRODUCTID INT NOT NULL
	PRIMARY KEY(TRANSACTIONID)
);

INSERT INTO SUPPLIERS VALUES
('MCKESSON','JOHN','JOHN40@GMAIL.COM','6145683223','915 TAYLOR RD'),
('SWDRX','EMILY','EMILY50@GMAIL.COM','6147568234','15851 SW 41ST STREET');

INSERT INTO PRODUCTS VALUES
('ASPIRIN 500MG', 'PAIN RELEIVER', 10.99, 100,'2024-06-30','1'),
('VITAMIN C 1000MG', 'SUPPLEMENT', 15.49, 50,'2024-12-31','2'),
('COUGH SYRUP 200ML', 'COUGH MEDICINE', 8.99, 75,'2024-03-15','3');

INSERT INTO TRANSACTIONS VALUES
('2024-06-21','10','PURCHASE','2'),
('2024-07-21','2','SALE','4'),
('2024-08-21','3','PURCHASE','6');

SELECT *FROM SUPPLIERS;

SELECT *FROM PRODUCTS;

SELECT *FROM TRANSACTIONS;

SELECT p.PRODUCTNAME, p.CATEGORY, p.PRICE FROM PRODUCTS p
JOIN SUPPLIERS s ON s.SUPPLIERSID = p.SUPPLIERSID
WHERE s.SUPPLIERSNAME = 'SWDRX';

SELECT p.PRODUCTNAME, p.CATEGORY, p.PRICE FROM PRODUCTS p
JOIN SUPPLIERS s ON s.SUPPLIERSID = p.SUPPLIERSID
WHERE s.SUPPLIERSNAME = 'MCKESSON';

SELECT SUM(PRICE) AS TOTALINVENTORYVALUE
FROM PRODUCTS p;

SELECT SUM(STOCK) AS TOTALINVENTORYVALUE
FROM PRODUCTS p;

SELECT SUM(PRICE * STOCK) AS TOTALINVENTORYVALUE
FROM PRODUCTS p;

SELECT SUM(PRICE + STOCK) AS TOTALINVENTORYVALUE
FROM PRODUCTS p;

SELECT SUM(PRICE/STOCK) AS TOTALINVENTORYVALUE
FROM PRODUCTS p;

DROP PROCEDURE ADDPRODUCT;

CREATE PROCEDURE ADDPRODUCT
    @PRODUCTNAME VARCHAR(20),
    @CATEGORY VARCHAR(30),
    @PRICE DECIMAL(20,2),
    @STOCK INT,
	@EXPIRYDATE DATE,
    @SUPPLIERSID INT
AS
BEGIN
    INSERT INTO PRODUCTS VALUES
           (@PRODUCTNAME, @CATEGORY, @PRICE, @STOCK, @EXPIRYDATE, @SUPPLIERSID);

    PRINT 'Product Added Successfully';
END;

DROP PROCEDURE RECORDTRANSACTION;

CREATE PROCEDURE RECORDTRANSACTION
	@TRANSACTIONDATE DATE,
	@QUANTITY INT,
	@TRANSACTIONTYPE VARCHAR(30),
	@PRODUCTID INT
AS
BEGIN
    IF @TRANSACTIONTYPE = 'PURCHASE'
	BEGIN
	    UPDATE PRODUCTS 
		SET STOCK = STOCK + @QUANTITY 
		WHERE PRODUCTID = @PRODUCTID;
    END
    ELSE IF @TRANSACTIONTYPE = 'SALE'
    BEGIN
        UPDATE PRODUCTS 
		SET STOCK = STOCK - @QUANTITY 
		WHERE PRODUCTID = @PRODUCTID;
    END

    INSERT INTO TRANSACTIONS VALUES
           (@TRANSACTIONDATE, @QUANTITY, @TRANSACTIONTYPE, @PRODUCTID);

    PRINT 'Transaction recorded successfully.';
END;

SELECT 
    PRODUCTNAME,
	EXPIRYDATE 
FROM 
    PRODUCTS
WHERE
    EXPIRYDATE < DATEADD(MONTH, 1, GETDATE());

SELECT
   p.PRODUCTNAME,
   t.TRANSACTIONDATE,
   t.QUANTITY,
   t.TRANSACTIONTYPE 
FROM
    TRANSACTIONS t
JOIN PRODUCTS p ON p.PRODUCTID = t.PRODUCTID
ORDER BY
    t.TRANSACTIONDATE DESC;

BACKUP DATABASE PharmacyDB TO 
DISK = '\\LAPTOP-FUD4S9PU\Projects\Inventory_backup.bak'
with compression,stats=10

RESTORE DATABASE PharmacyDB
FROM DISK = '\\LAPTOP-FUD4S9PU\Projects\Inventory_backup.bak'
